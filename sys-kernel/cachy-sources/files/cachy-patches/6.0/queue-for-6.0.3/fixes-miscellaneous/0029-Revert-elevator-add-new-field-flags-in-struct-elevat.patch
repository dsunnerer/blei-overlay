From 03308b82195ae7b4c74e1e6a1548dcba19d9c240 Mon Sep 17 00:00:00 2001
From: Piotr Gorski <lucjan.lucjanov@gmail.com>
Date: Thu, 20 Oct 2022 18:46:47 +0200
Subject: [PATCH 29/41] Revert "elevator: add new field flags in struct
 elevator_queue"

This reverts commit 804721046d109737bf0e07af7637dc5f8ed20702.

Signed-off-by: Piotr Gorski <lucjan.lucjanov@gmail.com>
---
 block/elevator.c | 6 ++++--
 block/elevator.h | 4 +---
 2 files changed, 5 insertions(+), 5 deletions(-)

diff --git a/block/elevator.c b/block/elevator.c
index 9e12706e8..20e70fd3f 100644
--- a/block/elevator.c
+++ b/block/elevator.c
@@ -512,7 +512,7 @@ int elv_register_queue(struct request_queue *q, bool uevent)
 		if (uevent)
 			kobject_uevent(&e->kobj, KOBJ_ADD);
 
-		set_bit(ELEVATOR_FLAG_REGISTERED, &e->flags);
+		e->registered = 1;
 	}
 	return error;
 }
@@ -523,9 +523,11 @@ void elv_unregister_queue(struct request_queue *q)
 
 	lockdep_assert_held(&q->sysfs_lock);
 
-	if (e && test_and_clear_bit(ELEVATOR_FLAG_REGISTERED, &e->flags)) {
+	if (e && e->registered) {
 		kobject_uevent(&e->kobj, KOBJ_REMOVE);
 		kobject_del(&e->kobj);
+
+		e->registered = 0;
 	}
 }
 
diff --git a/block/elevator.h b/block/elevator.h
index ed574bf3e..3f0593b3b 100644
--- a/block/elevator.h
+++ b/block/elevator.h
@@ -100,12 +100,10 @@ struct elevator_queue
 	void *elevator_data;
 	struct kobject kobj;
 	struct mutex sysfs_lock;
-	unsigned long flags;
+	unsigned int registered:1;
 	DECLARE_HASHTABLE(hash, ELV_HASH_BITS);
 };
 
-#define ELEVATOR_FLAG_REGISTERED 0
-
 /*
  * block elevator interface
  */
-- 
2.38.0.rc1.6.g4fd6c5e444

